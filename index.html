<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Basketball Rotation Tracker</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<style>
:root{
 --bg:#0f172a;--card:#1e293b;--border:#334155;--txt:#f1f5f9;
 --green:#22c55e;--orange:#f59e0b;--red:#ef4444;--muted:#94a3b8;
 --blue:#3b82f6;--purple:#8b5cf6;
 --fillGreen: rgba(34,197,94,.15);
 --fillOrange: rgba(245,158,11,.15);
 --fillRed: rgba(239,68,68,.15);
}
body{
  margin:0;
  background:var(--bg);
  color:var(--txt);
  font-family:system-ui, -apple-system, sans-serif;
  font-size:14px;
}
header{
  background:var(--card);
  border-bottom:1px solid var(--border);
  padding:12px 16px;
}
h1{
  margin:0;
  font-size:18px;
  font-weight:800;
  display:flex;
  align-items:center;
  gap:8px;
}
h1:before{
  content:"üèÄ";
}

/* ===== SCOREBOARD ===== */
.scoreboard-section{
  padding:12px 16px;
  background:linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
  border-bottom:1px solid var(--border);
}
.scoreboard{
  display:grid;
  grid-template-columns:1fr auto 1fr;
  gap:20px;
  align-items:center;
  margin-bottom:12px;
}
.team{
  text-align:center;
  padding:12px;
  background:rgba(30,41,59,0.6);
  border-radius:12px;
  border:1px solid var(--border);
}
.team-name{
  font-size:14px;
  font-weight:700;
  color:var(--muted);
  margin-bottom:4px;
}
.team-score{
  font-size:32px;
  font-weight:900;
  color:#fff;
}
.vs{
  font-size:12px;
  color:var(--muted);
  font-weight:700;
}

.quarter-scores{
  display:grid;
  grid-template-columns:repeat(5, 1fr);
  gap:8px;
  text-align:center;
}
.q-score{
  background:rgba(30,41,59,0.8);
  border-radius:8px;
  padding:6px;
  border:1px solid var(--border);
}
.q-label{
  font-size:11px;
  color:var(--muted);
  margin-bottom:2px;
}
.q-value{
  font-size:16px;
  font-weight:800;
}

/* ===== GAME CONTROLS ===== */
.game-controls{
  padding:12px 16px;
  background:var(--card);
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
  gap:12px;
}
.quarter-info{
  display:flex;
  align-items:center;
  gap:12px;
}
.q-display{
  background:var(--bg);
  padding:8px 16px;
  border-radius:10px;
  border:2px solid var(--blue);
  font-weight:900;
  font-size:16px;
  min-width:70px;
  text-align:center;
}
.clock-display{
  font-size:28px;
  font-weight:900;
  letter-spacing:1px;
  color:#fff;
  min-width:100px;
  text-align:center;
}
.control-buttons{
  display:flex;
  gap:10px;
  align-items:center;
}
.control-btn{
  padding:10px 16px;
  border-radius:10px;
  border:1px solid var(--border);
  background:var(--bg);
  color:var(--txt);
  font-weight:700;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:6px;
  white-space:nowrap;
}
.control-btn.primary{
  background:var(--blue);
  border-color:var(--blue);
}
.control-btn.play{
  background:var(--green);
  border-color:var(--green);
}
.control-btn:disabled{
  opacity:0.5;
  cursor:not-allowed;
}
.on-court-badge{
  background:rgba(34,197,94,.15);
  border:1px solid rgba(34,197,94,.3);
  color:var(--green);
  padding:6px 12px;
  border-radius:20px;
  font-size:12px;
  font-weight:700;
}

/* ===== POINT SCORING ===== */
.point-scoring{
  padding:12px 16px;
  border-bottom:1px solid var(--border);
  background:rgba(30,41,59,0.5);
}
.point-scoring h3{
  margin:0 0 10px 0;
  font-size:14px;
  color:var(--muted);
}
.point-buttons{
  display:flex;
  gap:10px;
}
.point-btn{
  flex:1;
  padding:14px;
  border-radius:10px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--txt);
  font-weight:900;
  font-size:16px;
  cursor:pointer;
  transition:all 0.2s;
}
.point-btn:hover{
  transform:translateY(-2px);
}
.point-btn.three{
  background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
  border-color:#7c3aed;
}
.point-btn.two{
  background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
  border-color:#2563eb;
}
.point-btn.one{
  background:linear-gradient(135deg, #10b981 0%, #059669 100%);
  border-color:#059669;
}

/* ===== MAIN LAYOUT ===== */
.main-layout{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
  padding:12px 16px;
}
@media(max-width:920px){
  .main-layout{ grid-template-columns:1fr; }
}

/* ===== COURT SECTION ===== */
.court-section{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:14px;
}
.section-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}
.section-header h2{
  margin:0;
  font-size:16px;
  font-weight:800;
  display:flex;
  align-items:center;
  gap:6px;
}
.section-header .small{
  font-size:12px;
  color:var(--muted);
}

.court-grid{
  display:grid;
  grid-template-columns:repeat(2, 1fr);
  gap:10px;
}
.court-slot{
  background:rgba(15,23,42,0.7);
  border:2px dashed rgba(148,163,184,0.3);
  border-radius:12px;
  padding:12px;
  min-height:160px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.court-slot.center{
  grid-column:1 / span 2;
  min-height:140px;
}
.court-slot .placeholder{
  color:rgba(148,163,184,0.5);
  font-weight:900;
  font-size:14px;
  letter-spacing:0.5px;
}

/* ===== BENCH SECTION ===== */
.bench-section{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:14px;
}
.bench-grid{
  display:grid;
  grid-template-columns:repeat(2, 1fr);
  gap:10px;
}
@media(max-width:520px){
  .bench-grid{ grid-template-columns:1fr; }
}

/* ===== PLAYER CARD ===== */
.player-card{
  background:var(--bg);
  border:1px solid var(--border);
  border-radius:10px;
  padding:12px;
  user-select:none;
  position:relative;
  transition:all 0.2s;
}
.player-card:active{
  transform:scale(0.98);
}
.player-card.dragging{
  opacity:0.6;
}
.player-card.on-court{
  border:2px solid var(--green);
  background:linear-gradient(135deg, rgba(34,197,94,0.1) 0%, transparent 100%);
}
.player-card.fillGreen{
  background:linear-gradient(135deg, var(--fillGreen), transparent);
}
.player-card.fillOrange{
  background:linear-gradient(135deg, var(--fillOrange), transparent);
}
.player-card.fillRed{
  background:linear-gradient(135deg, var(--fillRed), transparent);
}

.player-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:10px;
}
.player-name{
  font-weight:900;
  font-size:15px;
  color:#fff;
}
.player-number{
  color:var(--muted);
  font-size:12px;
  margin-top:2px;
}
.player-positions{
  display:flex;
  gap:4px;
  margin-top:4px;
}
.position-tag{
  font-size:10px;
  padding:2px 6px;
  border-radius:10px;
  background:rgba(30,41,59,0.8);
  color:var(--muted);
  border:1px solid var(--border);
}

.player-stats{
  display:grid;
  grid-template-columns:repeat(2, 1fr);
  gap:8px;
  margin:10px 0;
}
.stat-item{
  text-align:center;
}
.stat-label{
  font-size:10px;
  color:var(--muted);
  margin-bottom:2px;
}
.stat-value{
  font-weight:800;
  font-size:14px;
}
.stat-value.points{
  color:#fbbf24;
}

.player-fouls{
  background:rgba(30,41,59,0.8);
  border-radius:8px;
  padding:8px;
  margin:10px 0;
}
.foul-status{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.foul-count{
  font-weight:800;
  font-size:14px;
}
.foul-level{
  font-size:11px;
  padding:3px 8px;
  border-radius:10px;
  font-weight:700;
}
.foul-level.safe{
  background:rgba(34,197,94,0.15);
  color:var(--green);
}
.foul-level.warn{
  background:rgba(245,158,11,0.15);
  color:var(--orange);
}
.foul-level.bad{
  background:rgba(239,68,68,0.15);
  color:var(--red);
}

.player-actions{
  display:flex;
  gap:6px;
  margin-top:10px;
}
.action-btn{
  flex:1;
  padding:6px;
  border-radius:8px;
  border:1px solid var(--border);
  background:rgba(30,41,59,0.8);
  color:var(--txt);
  font-size:11px;
  font-weight:700;
  cursor:pointer;
  text-align:center;
}
.action-btn.foul{
  background:rgba(239,68,68,0.1);
  border-color:rgba(239,68,68,0.3);
}
.action-btn.edit{
  background:rgba(59,130,246,0.1);
  border-color:rgba(59,130,246,0.3);
}

/* ===== RECOMMENDATIONS ===== */
.recommendations-section{
  padding:12px 16px;
  background:var(--card);
  border-top:1px solid var(--border);
}
.recommendations-section h2{
  margin:0 0 8px 0;
  font-size:15px;
  display:flex;
  align-items:center;
  gap:6px;
}
.recommendations-list{
  list-style:none;
  padding:0;
  margin:0;
}
.recommendations-list li{
  padding:10px;
  background:rgba(15,23,42,0.5);
  border-radius:8px;
  margin-bottom:8px;
  border-left:3px solid var(--orange);
}
.recommendations-list .reason{
  font-size:12px;
  color:var(--muted);
  margin-top:4px;
}

/* ===== FOUL LISTS ===== */
.foul-lists{
  padding:12px 16px;
  background:var(--bg);
  border-top:1px solid var(--border);
}
.foul-lists-grid{
  display:grid;
  grid-template-columns:repeat(3, 1fr);
  gap:12px;
}
@media(max-width:920px){
  .foul-lists-grid{ grid-template-columns:1fr; }
}
.foul-list{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:10px;
  padding:12px;
}
.foul-list h3{
  margin:0 0 8px 0;
  font-size:14px;
  display:flex;
  align-items:center;
  gap:6px;
}
.foul-list ul{
  list-style:none;
  padding:0;
  margin:0;
}
.foul-list li{
  padding:6px 0;
  border-bottom:1px solid rgba(148,163,184,0.1);
  font-size:13px;
}
.foul-list li:last-child{
  border-bottom:none;
}

/* ===== MODAL ===== */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.modal.show{
  display:flex;
}
.modal-box{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:20px;
  width:min(500px, 90vw);
  max-height:80vh;
  overflow-y:auto;
}

/* ===== SELECTION HINT ===== */
.selection-hint{
  margin:0 16px 12px 16px;
  padding:10px 14px;
  background:rgba(30,41,59,0.8);
  border:1px solid var(--border);
  border-radius:10px;
  display:none;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}
.selection-hint.show{
  display:flex;
}
.selection-chip{
  padding:6px 12px;
  background:rgba(34,197,94,0.15);
  border:1px solid rgba(34,197,94,0.3);
  border-radius:20px;
  font-weight:700;
  font-size:12px;
  color:var(--green);
}

/* ===== ANIMATIONS ===== */
@keyframes pulse {
  0%{ box-shadow:0 0 0 0 rgba(34,197,94,0.5); }
  70%{ box-shadow:0 0 0 10px rgba(34,197,94,0); }
  100%{ box-shadow:0 0 0 0 rgba(34,197,94,0); }
}
.pulse{
  animation:pulse 1.5s infinite;
}

/* ===== TAP-TO-PLACE ===== */
.player-card.selected{
  border:2px solid var(--blue);
  box-shadow:0 0 0 3px rgba(59,130,246,0.2);
}

/* ===== VISUAL ALERTS ===== */
@keyframes pulseWarm {
  0%{ box-shadow: 0 0 0 rgba(245,158,11,0); }
  50%{ box-shadow: 0 0 0 3px rgba(245,158,11,.2); }
  100%{ box-shadow: 0 0 0 rgba(245,158,11,0); }
}
@keyframes pulseHot {
  0%{ box-shadow: 0 0 0 rgba(239,68,68,0); }
  50%{ box-shadow: 0 0 0 3px rgba(239,68,68,.2); }
  100%{ box-shadow: 0 0 0 rgba(239,68,68,0); }
}
@keyframes pulseBench {
  0%{ box-shadow: 0 0 0 rgba(148,163,184,0); }
  50%{ box-shadow: 0 0 0 3px rgba(148,163,184,.15); }
  100%{ box-shadow: 0 0 0 rgba(148,163,184,0); }
}

.pulseWarm{ animation: pulseWarm 1.6s ease-in-out infinite; }
.pulseHot{  animation: pulseHot  1.4s ease-in-out infinite; }
.pulseBench{ animation: pulseBench 1.8s ease-in-out infinite; }
</style>
</head>
<body>
<header>
  <h1>Basketball Rotation Tracker</h1>
</header>

<!-- SCOREBOARD -->
<div class="scoreboard-section">
  <div class="scoreboard">
    <div class="team" id="teamHome">
      <div class="team-name">HOME</div>
      <div class="team-score" id="scoreHome">0</div>
    </div>
    <div class="vs">VS</div>
    <div class="team" id="teamAway">
      <div class="team-name">AWAY</div>
      <div class="team-score" id="scoreAway">0</div>
    </div>
  </div>
  
  <div class="quarter-scores">
    <div class="q-score">
      <div class="q-label">Q1</div>
      <div class="q-value" id="q1Home">0</div>
      <div class="q-value" id="q1Away">0</div>
    </div>
    <div class="q-score">
      <div class="q-label">Q2</div>
      <div class="q-value" id="q2Home">0</div>
      <div class="q-value" id="q2Away">0</div>
    </div>
    <div class="q-score">
      <div class="q-label">Q3</div>
      <div class="q-value" id="q3Home">0</div>
      <div class="q-value" id="q3Away">0</div>
    </div>
    <div class="q-score">
      <div class="q-label">Q4</div>
      <div class="q-value" id="q4Home">0</div>
      <div class="q-value" id="q4Away">0</div>
    </div>
    <div class="q-score">
      <div class="q-label">TOTAL</div>
      <div class="q-value" id="totalHome">0</div>
      <div class="q-value" id="totalAway">0</div>
    </div>
  </div>
</div>

<!-- GAME CONTROLS -->
<div class="game-controls">
  <div class="quarter-info">
    <div class="q-display" id="quarterDisplay">Q1</div>
    <div class="clock-display" id="gameClock">10:00</div>
    <span class="on-court-badge" id="onCourtBadge">On Court: 0/5</span>
  </div>
  
  <div class="control-buttons">
    <button class="control-btn play" id="playBtn">‚ñ∂ PLAY</button>
    <button class="control-btn" id="undoBtn">‚Ü∫ UNDO</button>
    <button class="control-btn" id="stintsBtn">SET STINTS</button>
    <button class="control-btn" id="reportBtn">REPORT</button>
  </div>
</div>

<!-- POINT SCORING -->
<div class="point-scoring">
  <h3>ANOTAR PUNTOS</h3>
  <div class="point-buttons">
    <button class="point-btn three" data-points="3">+ 3 PTS</button>
    <button class="point-btn two" data-points="2">+ 2 PTS</button>
    <button class="point-btn one" data-points="1">+ 1 PT</button>
  </div>
</div>

<!-- TAP-TO-PLACE HINT -->
<div class="selection-hint" id="selectionHint">
  <div class="selection-info">
    <span class="selection-chip" id="selectedPlayerChip">Selected: -</span>
    <span class="small">Tap a court position to place player. Tap player again to deselect.</span>
  </div>
  <button class="action-btn" id="clearSelectionBtn">Cancel</button>
</div>

<!-- MAIN LAYOUT -->
<div class="main-layout">
  <!-- COURT SECTION -->
  <div class="court-section">
    <div class="section-header">
      <h2>üèÄ ON COURT</h2>
      <span class="small">Drag & drop to swap. Drop on slot = enter.</span>
    </div>
    <div class="court-grid" id="courtGrid">
      <div class="court-slot center" data-slot="0">
        <div class="placeholder">JOKER</div>
      </div>
      <div class="court-slot" data-slot="1">
        <div class="placeholder">ALERO</div>
      </div>
      <div class="court-slot" data-slot="2">
        <div class="placeholder">ALERO</div>
      </div>
      <div class="court-slot" data-slot="3">
        <div class="placeholder">BASE</div>
      </div>
      <div class="court-slot" data-slot="4">
        <div class="placeholder">ESCOLTA</div>
      </div>
    </div>
  </div>
  
  <!-- BENCH SECTION -->
  <div class="bench-section">
    <div class="section-header">
      <h2>ü™ë BENCH</h2>
      <span class="small">Drag to court to enter</span>
    </div>
    <div class="bench-grid" id="benchGrid"></div>
  </div>
</div>

<!-- RECOMMENDATIONS -->
<div class="recommendations-section">
  <h2>üîÅ SUB RECOMMENDATIONS</h2>
  <ul class="recommendations-list" id="recommendationsList">
    <li>No urgent changes needed</li>
  </ul>
</div>

<!-- FOUL WARNINGS -->
<div class="foul-lists">
  <div class="foul-lists-grid">
    <div class="foul-list">
      <h3>‚úÖ SAFE</h3>
      <ul id="foulSafeList"></ul>
    </div>
    <div class="foul-list">
      <h3>üü† WARNING</h3>
      <ul id="foulWarnList"></ul>
    </div>
    <div class="foul-list">
      <h3>üî¥ DANGER</h3>
      <ul id="foulDangerList"></ul>
    </div>
  </div>
</div>

<!-- PLAYER EDIT MODAL -->
<div id="playerModal" class="modal">
  <div class="modal-box">
    <h3>Edit Player</h3>
    <div style="margin:20px 0">
      <label style="display:block;margin-bottom:8px;font-size:12px;color:var(--muted)">Player Name</label>
      <input id="playerNameInput" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--txt)">
    </div>
    <div style="margin:20px 0">
      <label style="display:block;margin-bottom:8px;font-size:12px;color:var(--muted)">Positions (max 2)</label>
      <div id="positionPicker" style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="position-btn" data-pos="Base">Base</button>
        <button class="position-btn" data-pos="Escolta">Escolta</button>
        <button class="position-btn" data-pos="Alero">Alero</button>
        <button class="position-btn" data-pos="Joker">Joker</button>
      </div>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="control-btn" onclick="closePlayerModal()">Cancel</button>
      <button class="control-btn primary" id="savePlayerBtn">Save</button>
    </div>
  </div>
</div>

<!-- POINTS MODAL -->
<div id="pointsModal" class="modal">
  <div class="modal-box">
    <h3 id="pointsTitle">Who scored?</h3>
    <div class="bench-grid" id="pointsPlayerList"></div>
    <div style="display:flex;gap:10px;margin-top:20px">
      <button class="control-btn" style="background:#dc2626;color:#fff" onclick="addPointsToRival()">+ for Rival</button>
      <button class="control-btn" onclick="closePointsModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
// ========================
// STATE & CONFIG
// ========================
const MAX_ON_COURT = 5;
const QUARTER_TIME = 600; // 10 minutes in seconds
const SLOT_ROLES = ["Joker", "Alero", "Alero", "Base", "Escolta"];
const POSITION_OPTIONS = ["Base", "Escolta", "Alero", "Joker"];

// Game state
let gameRunning = false;
let currentQuarter = 1;
let quarterClock = QUARTER_TIME;
let gameElapsed = 0;
let lastTimestamp = performance.now();

// Score state
let homeScore = 0;
let awayScore = 0;
let quarterScores = {
  home: [0, 0, 0, 0],
  away: [0, 0, 0, 0]
};

// Player state
const players = Array.from({length: 12}, (_, i) => ({
  id: i,
  number: i + 1,
  name: `Player ${i + 1}`,
  positions: ["Base"],
  fouls: 0,
  foulStatus: "auto", // auto | forceBad | forceSafe
  points: 0,
  courtTotal: 0,
  benchTotal: 0,
  stint: 0,
  stintLimits: { green: 180, orange: 270 },
  foulLimits: { 1: 2, 2: 3, 3: 3, 4: 4 },
  fatigue: 0,
  qCourt: 0,
  qBench: 0,
  maxStint: 0,
  stintsCount: 0,
  courtFoulsStart: 0,
  stintType: "bench",
  stintStartLabel: "Q1 10:00",
  stintStartElapsedInQ: 0
}));

// Court slots (null = empty)
let courtSlots = [null, null, null, null, null];

// Selection for tap-to-place
let selectedPlayerId = null;

// Event log
let eventLog = [];
let pointsPending = 0;

// ========================
// UTILITY FUNCTIONS
// ========================
function formatTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function clamp(value, min, max) {
  return Math.max(min, Math.min(max, value));
}

function saveGameState() {
  const state = {
    version: 4,
    currentQuarter,
    quarterClock,
    gameElapsed,
    courtSlots,
    homeScore,
    awayScore,
    quarterScores,
    players: players.map(p => ({
      id: p.id,
      number: p.number,
      name: p.name,
      positions: p.positions,
      fouls: p.fouls,
      foulStatus: p.foulStatus,
      points: p.points,
      courtTotal: p.courtTotal,
      benchTotal: p.benchTotal,
      stint: p.stint,
      stintLimits: p.stintLimits,
      foulLimits: p.foulLimits
    })),
    eventLog
  };
  localStorage.setItem("basketball_tracker_state", JSON.stringify(state));
}

function loadGameState() {
  try {
    const saved = localStorage.getItem("basketball_tracker_state");
    if (!saved) return false;
    
    const state = JSON.parse(saved);
    if (!state || state.version !== 4) return false;
    
    currentQuarter = state.currentQuarter || 1;
    quarterClock = state.quarterClock || QUARTER_TIME;
    gameElapsed = state.gameElapsed || 0;
    courtSlots = state.courtSlots || [null, null, null, null, null];
    homeScore = state.homeScore || 0;
    awayScore = state.awayScore || 0;
    quarterScores = state.quarterScores || { home: [0,0,0,0], away: [0,0,0,0] };
    
    if (state.players && state.players.length === players.length) {
      state.players.forEach(sp => {
        const p = players[sp.id];
        if (!p) return;
        
        p.number = sp.number || p.number;
        p.name = sp.name || p.name;
        p.positions = sp.positions || p.positions;
        p.fouls = sp.fouls || p.fouls;
        p.foulStatus = sp.foulStatus || p.foulStatus;
        p.points = sp.points || p.points;
        p.courtTotal = sp.courtTotal || p.courtTotal;
        p.benchTotal = sp.benchTotal || p.benchTotal;
        p.stint = sp.stint || p.stint;
        p.stintLimits = sp.stintLimits || p.stintLimits;
        p.foulLimits = sp.foulLimits || p.foulLimits;
      });
    }
    
    eventLog = state.eventLog || [];
    return true;
  } catch (e) {
    console.error("Failed to load game state:", e);
    return false;
  }
}

// ========================
// SCORE MANAGEMENT
// ========================
function updateScores() {
  // Update team scores
  document.getElementById('scoreHome').textContent = homeScore;
  document.getElementById('scoreAway').textContent = awayScore;
  
  // Update quarter scores
  document.getElementById('q1Home').textContent = quarterScores.home[0];
  document.getElementById('q1Away').textContent = quarterScores.away[0];
  document.getElementById('q2Home').textContent = quarterScores.home[1];
  document.getElementById('q2Away').textContent = quarterScores.away[1];
  document.getElementById('q3Home').textContent = quarterScores.home[2];
  document.getElementById('q3Away').textContent = quarterScores.away[2];
  document.getElementById('q4Home').textContent = quarterScores.home[3];
  document.getElementById('q4Away').textContent = quarterScores.away[3];
  
  // Update totals
  document.getElementById('totalHome').textContent = homeScore;
  document.getElementById('totalAway').textContent = awayScore;
}

function addPoints(points, playerId) {
  if (playerId === 'rival') {
    awayScore += points;
    quarterScores.away[currentQuarter - 1] += points;
  } else {
    const player = players[playerId];
    if (!player) return;
    
    player.points += points;
    homeScore += points;
    quarterScores.home[currentQuarter - 1] += points;
    
    // Log the event
    eventLog.push({
      type: 'points',
      timestamp: Date.now(),
      quarter: currentQuarter,
      time: formatTime(QUARTER_TIME - quarterClock),
      playerId: playerId,
      playerName: player.name,
      points: points,
      totalPoints: player.points
    });
  }
  
  updateScores();
  saveGameState();
}

function openPointsModal(points) {
  pointsPending = points;
  document.getElementById('pointsTitle').textContent = `Who scored ${points} points?`;
  
  const list = document.getElementById('pointsPlayerList');
  list.innerHTML = '';
  
  courtSlots.forEach((playerId, index) => {
    if (playerId === null) return;
    
    const player = players[playerId];
    const card = document.createElement('div');
    card.className = 'player-card';
    card.innerHTML = `
      <div class="player-header">
        <div>
          <div class="player-name">${player.name}</div>
          <div class="player-number">#${player.number}</div>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-label">POINTS</div>
        <div class="stat-value points">${player.points}</div>
      </div>
    `;
    card.onclick = () => {
      addPoints(pointsPending, playerId);
      closePointsModal();
    };
    list.appendChild(card);
  });
  
  document.getElementById('pointsModal').classList.add('show');
}

function closePointsModal() {
  document.getElementById('pointsModal').classList.remove('show');
  pointsPending = 0;
}

function addPointsToRival() {
  addPoints(pointsPending, 'rival');
  closePointsModal();
}

// ========================
// PLAYER MANAGEMENT
// ========================
function isOnCourt(playerId) {
  return courtSlots.includes(playerId);
}

function getBenchPlayers() {
  const courtSet = new Set(courtSlots.filter(id => id !== null));
  return players.filter(p => !courtSet.has(p.id));
}

function getStintClass(player) {
  if (player.stint < player.stintLimits.green) return 'fillGreen';
  if (player.stint < player.stintLimits.orange) return 'fillOrange';
  return 'fillRed';
}

function getFoulLevel(player) {
  if (player.foulStatus === 'forceBad') return 'bad';
  if (player.foulStatus === 'forceSafe') return 'safe';
  
  const limit = player.foulLimits[currentQuarter] || 5;
  if (player.fouls >= limit) return 'bad';
  if (player.fouls === limit - 1) return 'warn';
  return 'safe';
}

// ========================
// RENDERING
// ========================
function renderPlayerCard(player, compact = false) {
  const onCourt = isOnCourt(player.id);
  const foulLevel = getFoulLevel(player);
  const stintClass = getStintClass(player);
  const foulLimit = player.foulLimits[currentQuarter] || 5;
  
  let foulLevelText = '';
  let foulLevelClass = '';
  switch (foulLevel) {
    case 'safe': foulLevelText = '‚úÖ SAFE'; foulLevelClass = 'safe'; break;
    case 'warn': foulLevelText = 'üü† WARN'; foulLevelClass = 'warn'; break;
    case 'bad': foulLevelText = 'üî¥ DANGER'; foulLevelClass = 'bad'; break;
  }
  
  const animationClass = onCourt 
    ? (player.stint >= player.stintLimits.orange ? 'pulseHot' : 
       (player.stint >= player.stintLimits.green ? 'pulseWarm' : ''))
    : (player.stint >= player.stintLimits.orange ? 'pulseBench' : '');
  
  const selectedClass = selectedPlayerId === player.id ? 'selected' : '';
  
  if (compact) {
    return `
      <div class="player-card ${onCourt ? 'on-court' : ''} ${stintClass} ${animationClass} ${selectedClass}" 
           draggable="true" data-pid="${player.id}">
        <div class="player-header">
          <div>
            <div class="player-name">${player.name}</div>
            <div class="player-number">#${player.number}</div>
          </div>
          <button class="action-btn edit" onclick="editPlayer(${player.id})">Edit</button>
        </div>
        
        <div class="player-stats">
          <div class="stat-item">
            <div class="stat-label">STINT</div>
            <div class="stat-value">${formatTime(player.stint)}</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">PTS</div>
            <div class="stat-value points">${player.points}</div>
          </div>
        </div>
        
        <div class="player-fouls">
          <div class="foul-status">
            <div class="foul-count">Fouls: ${player.fouls}/${foulLimit}</div>
            <div class="foul-level ${foulLevelClass}">${foulLevelText}</div>
          </div>
        </div>
        
        <div class="player-actions">
          <button class="action-btn foul" onclick="adjustFoul(${player.id}, 1)">+ Foul</button>
          <button class="action-btn" onclick="adjustFoul(${player.id}, -1)">- Foul</button>
        </div>
      </div>
    `;
  } else {
    return `
      <div class="player-card ${onCourt ? 'on-court' : ''} ${stintClass} ${animationClass} ${selectedClass}" 
           draggable="true" data-pid="${player.id}">
        <div class="player-header">
          <div>
            <div class="player-name">${player.name}</div>
            <div class="player-number">#${player.number}</div>
            <div class="player-positions">
              ${player.positions.map(pos => `<span class="position-tag">${pos}</span>`).join('')}
            </div>
          </div>
          <button class="action-btn edit" onclick="editPlayer(${player.id})">Edit</button>
        </div>
        
        <div class="player-stats">
          <div class="stat-item">
            <div class="stat-label">COURT</div>
            <div class="stat-value">${formatTime(player.courtTotal)}</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">BENCH</div>
            <div class="stat-value">${formatTime(player.benchTotal)}</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">STINT</div>
            <div class="stat-value">${formatTime(player.stint)}</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">PTS</div>
            <div class="stat-value points">${player.points}</div>
          </div>
        </div>
        
        <div class="player-fouls">
          <div class="foul-status">
            <div class="foul-count">Fouls: ${player.fouls}/${foulLimit}</div>
            <div class="foul-level ${foulLevelClass}">${foulLevelText}</div>
          </div>
        </div>
        
        <div class="player-actions">
          <button class="action-btn foul" onclick="adjustFoul(${player.id}, 1)">+ Foul</button>
          <button class="action-btn" onclick="adjustFoul(${player.id}, -1)">- Foul</button>
          <button class="action-btn" onclick="forceFoulStatus(${player.id}, 'safe')">‚úÖ</button>
          <button class="action-btn" onclick="forceFoulStatus(${player.id}, 'bad')">üî¥</button>
          <button class="action-btn" onclick="forceFoulStatus(${player.id}, 'auto')">AUTO</button>
        </div>
      </div>
    `;
  }
}

function render() {
  // Update game info
  document.getElementById('quarterDisplay').textContent = `Q${currentQuarter}`;
  document.getElementById('gameClock').textContent = formatTime(quarterClock);
  
  const onCourtCount = courtSlots.filter(id => id !== null).length;
  document.getElementById('onCourtBadge').textContent = `On Court: ${onCourtCount}/5`;
  
  // Render court slots
  const courtGrid = document.getElementById('courtGrid');
  courtGrid.innerHTML = '';
  
  courtSlots.forEach((playerId, index) => {
    const slot = document.createElement('div');
    slot.className = `court-slot ${index === 0 ? 'center' : ''}`;
    slot.dataset.slot = index;
    
    if (playerId === null) {
      slot.innerHTML = `<div class="placeholder">${SLOT_ROLES[index]}</div>`;
    } else {
      slot.innerHTML = renderPlayerCard(players[playerId], true);
    }
    
    // Add drag and drop events
    slot.addEventListener('dragover', e => e.preventDefault());
    slot.addEventListener('drop', handleDrop);
    slot.addEventListener('click', handleSlotClick);
    
    courtGrid.appendChild(slot);
  });
  
  // Render bench
  const benchGrid = document.getElementById('benchGrid');
  benchGrid.innerHTML = '';
  
  getBenchPlayers().forEach(player => {
    const card = document.createElement('div');
    card.innerHTML = renderPlayerCard(player, false);
    benchGrid.appendChild(card);
  });
  
  // Update selection hint
  updateSelectionHint();
  
  // Update foul lists
  updateFoulLists();
  
  // Update recommendations
  updateRecommendations();
  
  // Update play button state
  document.getElementById('playBtn').disabled = !gameRunning && onCourtCount !== 5;
}

// ========================
// GAME LOGIC
// ========================
function gameTick(timestamp) {
  if (!gameRunning) return;
  
  const deltaTime = (timestamp - lastTimestamp) / 1000;
  lastTimestamp = timestamp;
  
  gameElapsed += deltaTime;
  quarterClock = clamp(quarterClock - deltaTime, 0, QUARTER_TIME);
  
  // Update player times
  const onCourtSet = new Set(courtSlots.filter(id => id !== null));
  
  players.forEach(player => {
    const onCourt = onCourtSet.has(player.id);
    
    // Update stint time
    player.stint += deltaTime;
    
    // Update totals
    if (onCourt) {
      player.courtTotal += deltaTime;
      player.qCourt += deltaTime;
    } else {
      player.benchTotal += deltaTime;
      player.qBench += deltaTime;
    }
    
    // Update max stint
    player.maxStint = Math.max(player.maxStint, player.stint);
    
    // Update fatigue
    const build = onCourt ? deltaTime * (1.0 + 0.6 * (player.qCourt / 300)) : 0;
    const recover = !onCourt ? deltaTime * (0.85 + 0.25 * (player.qBench / 180)) : 0;
    player.fatigue = Math.max(0, player.fatigue + build - recover);
  });
  
  // Check for quarter end
  if (quarterClock <= 0) {
    quarterClock = 0;
    gameRunning = false;
    if (currentQuarter < 4) {
      setTimeout(() => {
        if (confirm(`Quarter ${currentQuarter} ended. Move to Q${currentQuarter + 1}?`)) {
          nextQuarter();
        }
      }, 100);
    } else {
      alert('Game ended!');
    }
  }
  
  saveGameState();
  render();
  requestAnimationFrame(gameTick);
}

function toggleGame() {
  if (!gameRunning) {
    const onCourtCount = courtSlots.filter(id => id !== null).length;
    if (onCourtCount !== 5) {
      alert('Cannot start: need 5 players on court.');
      return;
    }
    gameRunning = true;
    lastTimestamp = performance.now();
    requestAnimationFrame(gameTick);
    document.getElementById('playBtn').textContent = '‚è∏ PAUSE';
  } else {
    gameRunning = false;
    document.getElementById('playBtn').textContent = '‚ñ∂ PLAY';
  }
  saveGameState();
}

function nextQuarter() {
  if (currentQuarter < 4) {
    currentQuarter++;
    quarterClock = QUARTER_TIME;
    
    // Reset quarter-specific player stats
    players.forEach(p => {
      p.qCourt = 0;
      p.qBench = 0;
    });
    
    eventLog.push({
      type: 'quarter',
      timestamp: Date.now(),
      quarter: currentQuarter
    });
    
    saveGameState();
    render();
  }
}

function prevQuarter() {
  if (currentQuarter > 1) {
    currentQuarter--;
    quarterClock = QUARTER_TIME;
    saveGameState();
    render();
  }
}

// ========================
// DRAG & DROP
// ========================
function handleDrop(e) {
  e.preventDefault();
  const playerId = parseInt(e.dataTransfer.getData('text/plain'));
  const slotIndex = parseInt(e.target.closest('.court-slot').dataset.slot);
  
  if (isNaN(playerId)) return;
  
  movePlayerToSlot(playerId, slotIndex);
}

function handleSlotClick(e) {
  const slotElement = e.target.closest('.court-slot');
  if (!slotElement || selectedPlayerId === null) return;
  
  const slotIndex = parseInt(slotElement.dataset.slot);
  movePlayerToSlot(selectedPlayerId, slotIndex);
  clearSelection();
}

function movePlayerToSlot(playerId, slotIndex) {
  const currentSlot = courtSlots.indexOf(playerId);
  const outgoingPlayerId = courtSlots[slotIndex];
  
  if (currentSlot !== -1) {
    // Swap positions
    courtSlots[slotIndex] = playerId;
    courtSlots[currentSlot] = outgoingPlayerId;
    
    // Reset stints for swapped players
    players[playerId].stint = 0;
    players[playerId].stintsCount++;
    if (outgoingPlayerId !== null) {
      players[outgoingPlayerId].stint = 0;
      players[outgoingPlayerId].stintsCount++;
    }
    
    eventLog.push({
      type: 'swap',
      timestamp: Date.now(),
      quarter: currentQuarter,
      time: formatTime(QUARTER_TIME - quarterClock),
      playerA: playerId,
      playerB: outgoingPlayerId,
      slot: slotIndex
    });
  } else {
    // Player entering from bench
    courtSlots[slotIndex] = playerId;
    
    // Reset stint for entering player
    players[playerId].stint = 0;
    players[playerId].stintsCount++;
    
    // If someone was replaced, send them to bench
    if (outgoingPlayerId !== null) {
      players[outgoingPlayerId].stint = 0;
      players[outgoingPlayerId].stintsCount++;
      
      eventLog.push({
        type: 'sub',
        timestamp: Date.now(),
        quarter: currentQuarter,
        time: formatTime(QUARTER_TIME - quarterClock),
        in: playerId,
        out: outgoingPlayerId,
        slot: slotIndex
      });
    }
  }
  
  saveGameState();
  render();
}

// ========================
// SELECTION MANAGEMENT
// ========================
function toggleSelection(playerId) {
  if (selectedPlayerId === playerId) {
    selectedPlayerId = null;
  } else {
    selectedPlayerId = playerId;
  }
  updateSelectionHint();
  render();
}

function clearSelection() {
  selectedPlayerId = null;
  updateSelectionHint();
  render();
}

function updateSelectionHint() {
  const hint = document.getElementById('selectionHint');
  const chip = document.getElementById('selectedPlayerChip');
  
  if (selectedPlayerId === null) {
    hint.classList.remove('show');
  } else {
    hint.classList.add('show');
    const player = players[selectedPlayerId];
    chip.textContent = `Selected: ${player.name}`;
  }
}

// ========================
// FOUL MANAGEMENT
// ========================
function adjustFoul(playerId, amount) {
  const player = players[playerId];
  player.fouls = clamp(player.fouls + amount, 0, 5);
  
  eventLog.push({
    type: 'foul',
    timestamp: Date.now(),
    quarter: currentQuarter,
    time: formatTime(QUARTER_TIME - quarterClock),
    playerId: playerId,
    playerName: player.name,
    fouls: player.fouls,
    change: amount
  });
  
  saveGameState();
  render();
}

function forceFoulStatus(playerId, status) {
  const player = players[playerId];
  player.foulStatus = status;
  saveGameState();
  render();
}

function updateFoulLists() {
  const safeList = document.getElementById('foulSafeList');
  const warnList = document.getElementById('foulWarnList');
  const dangerList = document.getElementById('foulDangerList');
  
  safeList.innerHTML = '';
  warnList.innerHTML = '';
  dangerList.innerHTML = '';
  
  players.sort((a, b) => b.fouls - a.fouls).forEach(player => {
    const item = `<li>${player.name} (${player.fouls})</li>`;
    const level = getFoulLevel(player);
    
    if (level === 'safe') safeList.innerHTML += item;
    else if (level === 'warn') warnList.innerHTML += item;
    else if (level === 'bad') dangerList.innerHTML += item;
  });
}

// ========================
// RECOMMENDATIONS
// ========================
function updateRecommendations() {
  const list = document.getElementById('recommendationsList');
  list.innerHTML = '';
  
  const recommendations = [];
  const benchPlayers = getBenchPlayers();
  
  courtSlots.forEach((playerId, slotIndex) => {
    if (playerId === null) return;
    
    const player = players[playerId];
    const foulLevel = getFoulLevel(player);
    const stintRatio = player.stint / player.stintLimits.orange;
    
    // Check if player needs substitution
    const needsSub = foulLevel === 'bad' || 
                     foulLevel === 'warn' || 
                     stintRatio >= 1.0 ||
                     player.fatigue > 15;
    
    if (needsSub) {
      const slotRole = SLOT_ROLES[slotIndex];
      const suitableReplacements = benchPlayers.filter(bp => 
        bp.positions.includes(slotRole) || bp.positions.includes('Joker')
      );
      
      if (suitableReplacements.length > 0) {
        const reason = [];
        if (foulLevel === 'bad') reason.push('foul trouble');
        if (foulLevel === 'warn') reason.push('foul warning');
        if (stintRatio >= 1.0) reason.push('long stint');
        if (player.fatigue > 15) reason.push('fatigue');
        
        const replacement = suitableReplacements[0];
        recommendations.push({
          text: `OUT: ${player.name} (${slotRole}) ‚Üí IN: ${replacement.name}`,
          reason: reason.join(', ')
        });
      }
    }
  });
  
  if (recommendations.length === 0) {
    list.innerHTML = '<li>No urgent changes needed</li>';
  } else {
    recommendations.slice(0, 3).forEach(rec => {
      list.innerHTML += `
        <li>
          <strong>${rec.text}</strong>
          <div class="reason">${rec.reason}</div>
        </li>
      `;
    });
  }
}

// ========================
// PLAYER EDITING
// ========================
let editingPlayerId = null;

function editPlayer(playerId) {
  editingPlayerId = playerId;
  const player = players[playerId];
  
  document.getElementById('playerNameInput').value = player.name;
  
  // Update position buttons
  document.querySelectorAll('.position-btn').forEach(btn => {
    const pos = btn.dataset.pos;
    const isSelected = player.positions.includes(pos);
    btn.style.background = isSelected ? 'var(--blue)' : 'var(--bg)';
    btn.style.opacity = isSelected ? '1' : '0.7';
  });
  
  document.getElementById('playerModal').classList.add('show');
}

function closePlayerModal() {
  document.getElementById('playerModal').classList.remove('show');
  editingPlayerId = null;
}

function savePlayer() {
  if (editingPlayerId === null) return;
  
  const player = players[editingPlayerId];
  const nameInput = document.getElementById('playerNameInput').value.trim();
  
  if (nameInput) {
    player.name = nameInput;
  }
  
  // Get selected positions
  const selectedPositions = [];
  document.querySelectorAll('.position-btn').forEach(btn => {
    const pos = btn.dataset.pos;
    if (btn.style.background === 'var(--blue)') {
      selectedPositions.push(pos);
    }
  });
  
  if (selectedPositions.length > 0) {
    player.positions = selectedPositions.slice(0, 2);
  }
  
  saveGameState();
  closePlayerModal();
  render();
}

// ========================
// EVENT LISTENERS
// ========================
document.addEventListener('DOMContentLoaded', () => {
  // Load saved state
  loadGameState();
  
  // Initialize scores
  updateScores();
  
  // Game controls
  document.getElementById('playBtn').onclick = toggleGame;
  document.getElementById('undoBtn').onclick = () => {
    // TODO: Implement undo functionality
    alert('Undo feature coming soon!');
  };
  document.getElementById('stintsBtn').onclick = () => {
    // TODO: Implement stints management
    alert('Stints management coming soon!');
  };
  document.getElementById('reportBtn').onclick = () => {
    // TODO: Implement report generation
    alert('Report generation coming soon!');
  };
  
  // Quarter navigation
  document.getElementById('quarterDisplay').onclick = () => {
    const newQuarter = prompt('Enter quarter (1-4):', currentQuarter);
    if (newQuarter && newQuarter >= 1 && newQuarter <= 4) {
      currentQuarter = parseInt(newQuarter);
      quarterClock = QUARTER_TIME;
      saveGameState();
      render();
    }
  };
  
  // Point buttons
  document.querySelectorAll('.point-btn').forEach(btn => {
    btn.onclick = () => {
      const points = parseInt(btn.dataset.points);
      openPointsModal(points);
    };
  });
  
  // Clear selection
  document.getElementById('clearSelectionBtn').onclick = clearSelection;
  
  // Player modal
  document.getElementById('savePlayerBtn').onclick = savePlayer;
  
  // Position buttons
  document.querySelectorAll('.position-btn').forEach(btn => {
    btn.onclick = function() {
      const currentBg = this.style.background;
      const isSelected = currentBg === 'var(--blue)';
      
      // Count currently selected positions
      const selectedCount = Array.from(document.querySelectorAll('.position-btn'))
        .filter(b => b.style.background === 'var(--blue)').length;
      
      if (!isSelected && selectedCount >= 2) {
        alert('Maximum 2 positions per player.');
        return;
      }
      
      this.style.background = isSelected ? 'var(--bg)' : 'var(--blue)';
      this.style.opacity = isSelected ? '0.7' : '1';
    };
  });
  
  // Close modals when clicking outside
  document.querySelectorAll('.modal').forEach(modal => {
    modal.onclick = function(e) {
      if (e.target === this) {
        this.classList.remove('show');
      }
    };
  });
  
  // Initial render
  render();
});

// ========================
// DRAG & DROP SETUP
// ========================
document.addEventListener('dragstart', e => {
  if (e.target.classList.contains('player-card')) {
    const playerId = e.target.dataset.pid;
    e.dataTransfer.setData('text/plain', playerId);
    e.target.classList.add('dragging');
  }
});

document.addEventListener('dragend', e => {
  if (e.target.classList.contains('player-card')) {
    e.target.classList.remove('dragging');
  }
});

// Click to select player
document.addEventListener('click', e => {
  const playerCard = e.target.closest('.player-card');
  if (playerCard && !e.target.closest('button')) {
    const playerId = parseInt(playerCard.dataset.pid);
    toggleSelection(playerId);
  }
});
</script>
</body>
</html>
